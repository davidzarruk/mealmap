import { mkdir, readFile, writeFile } from 'node:fs/promises';

const inputPath = new URL('../docs/seed-meals-phase2.json', import.meta.url);
const outputPath = new URL('../supabase/seed/20260216_phase2_seed_meals.sql', import.meta.url);

const rows = JSON.parse(await readFile(inputPath, 'utf8'));

const values = rows
  .map((m) => {
    const tags = `{${(m.tags || []).map((t) => `"${String(t).replaceAll('"', '\\"')}"`).join(',')}}`;
    return `('${m.slug}', '${m.title.replaceAll("'", "''")}', '${m.region}', '${m.skill_level}', ${m.prep_time_min}, '${m.slot}', '${tags}')`;
  })
  .join(',\n');

const sql = `-- generated by scripts/generate-seed-meals-sql.mjs\ncreate table if not exists meal_seeds (\n  id bigint generated always as identity primary key,\n  slug text unique not null,\n  title text not null,\n  region text not null default 'CO',\n  skill_level text not null,\n  prep_time_min int not null,\n  slot text not null default 'lunch',\n  tags text[] not null default '{}'::text[],\n  created_at timestamptz not null default now()\n);\n\ninsert into meal_seeds (slug, title, region, skill_level, prep_time_min, slot, tags)\nvalues\n${values}\non conflict (slug) do update set\n  title = excluded.title,\n  region = excluded.region,\n  skill_level = excluded.skill_level,\n  prep_time_min = excluded.prep_time_min,\n  slot = excluded.slot,\n  tags = excluded.tags;\n`;

await mkdir(new URL('../supabase/seed/', import.meta.url), { recursive: true });
await writeFile(outputPath, sql, 'utf8');
console.log(`âœ… seed SQL generado en ${outputPath.pathname}`);
